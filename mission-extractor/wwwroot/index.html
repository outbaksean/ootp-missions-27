<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Mission Extractor</title>
<style>
* { box-sizing: border-box; }
body { font-family: monospace; font-size: 13px; background: #fff; color: #111; margin: 0; padding: 16px; }
h1 { font-size: 1em; margin: 0 0 12px; }
.controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
button { font-family: monospace; font-size: 13px; padding: 4px 10px; cursor: pointer; border: 1px solid #999; background: #f4f4f4; }
button:hover { background: #e4e4e4; }
#load-form { display: none; margin-bottom: 10px; }
#load-form input { font-family: monospace; font-size: 13px; padding: 3px 6px; border: 1px solid #999; width: 420px; }
pre#log { background: #f8f8f8; border: 1px solid #ddd; padding: 8px; height: 120px; overflow-y: auto; margin: 0 0 12px; white-space: pre-wrap; word-break: break-all; font-size: 12px; }
#missions { margin-top: 4px; }
details { border: 1px solid #ddd; margin-bottom: 8px; }
summary { padding: 6px 10px; cursor: pointer; background: #f4f4f4; font-weight: bold; list-style: none; }
summary::-webkit-details-marker { display: none; }
.mission-body { padding: 10px 12px; }
.field-row { margin-bottom: 10px; }
.field-label { display: block; font-weight: bold; margin-bottom: 3px; color: #555; }
.field-row input[type="text"] { font-family: monospace; font-size: 13px; padding: 3px 6px; border: 1px solid #bbb; width: 100%; max-width: 600px; }
.error-star { color: #c00; font-weight: bold; margin-left: 4px; }
.mission-errors { background: #fff8f8; border: 1px solid #f5c6c6; padding: 6px 10px; margin-bottom: 10px; font-size: 12px; color: #c00; }
.mission-errors div { margin: 1px 0; }
.mission-json { background: #f8f8f8; border: 1px solid #eee; padding: 8px 10px; margin-bottom: 10px; font-size: 11px; max-height: 200px; overflow-y: auto; white-space: pre; }
.debug-imgs { margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px; }
.debug-imgs img { max-height: 80px; image-rendering: pixelated; border: 1px solid #ccc; }
.save-row { margin-top: 10px; display: flex; align-items: center; gap: 10px; }
.save-status { font-size: 12px; color: #555; }
.save-status.error { color: #c00; }
.btn-delete { font-family: monospace; font-size: 13px; padding: 4px 10px; cursor: pointer; border: 1px solid #c00; background: #fff; color: #c00; }
.btn-delete:hover { background: #fff0f0; }
.detail-entry { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
.detail-entry input[type="text"] { flex: 1; max-width: 560px; }
.detail-entry img { display: block; max-height: 80px; image-rendering: pixelated; border: 1px solid #ccc; }
</style>
</head>
<body>

<h1 id="page-title">Mission Extractor</h1>

<div class="controls">
  <button onclick="runCapture()">Capture</button>
  <button id="btn-capture-details-bottom" onclick="runCaptureDetailsBottom()" disabled>Capture More Details</button>
  <button onclick="runValidate()">Validate</button>
  <button onclick="runTransform()">Transform</button>
  <button onclick="runSaveUnstructured()">Save Unstructured</button>
  <button onclick="toggleLoadForm()">Load Unstructured</button>
  <button onclick="runDeleteDebugImages()">Delete Debug Images</button>
  <button onclick="runClearMissions()">Clear Missions</button>
</div>

<div id="load-form">
  <input type="text" id="load-path" placeholder="Path to unstructured missions JSON file">
  <button onclick="runLoadUnstructured()">Load</button>
</div>

<pre id="log">Ready.</pre>

<div id="missions"></div>

<script>
// fieldErrors: { [missionId]: Set<fieldName> } â€” populated after validate/transform
let fieldErrors = {};

function errorTypeToField(errorType) {
  if (errorType === 'Name Blank') return 'name';
  if (errorType.startsWith('Category')) return 'category';
  if (errorType === 'Reward Blank') return 'reward';
  if (errorType === 'Status Blank' || errorType === 'Type Unparsed') return 'status';
  return 'missionDetails';
}

function buildErrorMap(errors) {
  const map = {};
  for (const e of errors) {
    if (!map[e.missionId]) map[e.missionId] = [];
    map[e.missionId].push(e.errorType);
  }
  return map;
}

function setLog(text) {
  document.getElementById('log').textContent = text;
}

function appendLog(text) {
  const el = document.getElementById('log');
  el.textContent += text;
  el.scrollTop = el.scrollHeight;
}

function updateTitle(count) {
  document.getElementById('page-title').textContent =
    'Mission Extractor \u2014 ' + count + ' mission(s)';
  document.getElementById('btn-capture-details-bottom').disabled = count === 0;
}

async function refreshMissions() {
  const res = await fetch('/api/missions');
  const data = await res.json();
  updateTitle(data.count);
  renderMissions(data.missions);
}

function renderMissions(missions) {
  const container = document.getElementById('missions');
  container.innerHTML = '';
  for (const m of missions) {
    container.appendChild(buildMissionElement(m));
  }
}

function buildMissionElement(m) {
  const det = document.createElement('details');
  det.dataset.id = m.id;

  const sum = document.createElement('summary');
  sum.textContent = summaryText(m);
  det.appendChild(sum);

  const body = document.createElement('div');
  body.className = 'mission-body';

  const missionErrorTypes = fieldErrors[m.id] ?? [];

  if (missionErrorTypes.length > 0) {
    const errBlock = document.createElement('div');
    errBlock.className = 'mission-errors';
    for (const e of missionErrorTypes) {
      const row = document.createElement('div');
      row.textContent = e;
      errBlock.appendChild(row);
    }
    body.appendChild(errBlock);
  }

  // Simple text fields
  for (const field of ['name', 'category', 'reward', 'status']) {
    body.appendChild(buildTextField(field, m[field] ?? '', m.debugImages, missionErrorTypes));
  }

  // Full mission JSON (read-only, collapsible)
  const jsonDetails = document.createElement('details');
  const jsonSummary = document.createElement('summary');
  jsonSummary.textContent = 'JSON';
  jsonDetails.appendChild(jsonSummary);
  const { status, missionDetails, debugImages, ...finalFields } = m;
  const pre = document.createElement('pre');
  pre.className = 'mission-json';
  pre.textContent = JSON.stringify(finalFields, null, 2);
  jsonDetails.appendChild(pre);
  body.appendChild(jsonDetails);

  // missionDetails
  body.appendChild(buildDetailsField(m.missionDetails ?? [], m.debugImages, missionErrorTypes));

  // Save row
  const saveRow = document.createElement('div');
  saveRow.className = 'save-row';
  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Save';
  saveBtn.onclick = function() { saveMission(this); };
  const saveStatus = document.createElement('span');
  saveStatus.className = 'save-status';
  const deleteBtn = document.createElement('button');
  deleteBtn.textContent = 'Delete Mission';
  deleteBtn.className = 'btn-delete';
  deleteBtn.onclick = function() { deleteMission(this); };
  saveRow.appendChild(saveBtn);
  saveRow.appendChild(saveStatus);
  saveRow.appendChild(deleteBtn);
  body.appendChild(saveRow);

  det.appendChild(body);
  return det;
}

function summaryText(m) {
  return '[' + m.id + '] ' + (m.name || '') +
    '  (' + (m.category || '') + ')' +
    '  |  ' + (m.type || '') +
    '  |  ' + (m.status || '');
}


function buildTextField(field, value, debugImages, missionErrorTypes) {
  const row = document.createElement('div');
  row.className = 'field-row';

  const hasError = missionErrorTypes.some(e => errorTypeToField(e) === field);

  const label = document.createElement('label');
  label.className = 'field-label';
  label.textContent = field;
  if (hasError) {
    const star = document.createElement('span');
    star.className = 'error-star';
    star.textContent = '*';
    label.appendChild(star);
  }
  row.appendChild(label);

  const input = document.createElement('input');
  input.type = 'text';
  input.dataset.field = field;
  input.value = value;
  row.appendChild(input);

  if (field === 'status') {
    const btnRow = document.createElement('div');
    btnRow.style.cssText = 'display:flex;gap:6px;margin-top:4px;';
    const presets = [
      { label: 'Set Type Count',    value: '0 / 1 out of 1' },
      { label: 'Set Type Points',   value: '0 / 1 Points' },
      { label: 'Set Type Missions', value: '0 / 1 Missions' },
    ];
    for (const preset of presets) {
      const btn = document.createElement('button');
      btn.textContent = preset.label;
      btn.onclick = function() { input.value = preset.value; };
      btnRow.appendChild(btn);
    }
    row.appendChild(btnRow);
  }

  const imgs = debugImages?.[field];
  if (imgs && imgs.length > 0) {
    const imgContainer = document.createElement('div');
    imgContainer.className = 'debug-imgs';
    for (const imgPath of imgs) {
      const filename = imgPath.split(/[\\/]/).pop();
      const img = document.createElement('img');
      img.src = '/debug-images/' + filename;
      img.alt = field + ' debug image';
      imgContainer.appendChild(img);
    }
    row.appendChild(imgContainer);
  }

  return row;
}

function buildDetailsField(details, debugImages, missionErrorTypes) {
  const row = document.createElement('div');
  row.className = 'field-row';

  // Separate named errors (Card Not Found, Mission Not Found, Points Mismatch) from
  // aggregate errors (MissionDetails Empty, Total Points Mismatch, etc.).
  const detailErrors = missionErrorTypes.filter(e => errorTypeToField(e) === 'missionDetails');
  const errorIndices = new Set();
  let aggregateError = false;

  for (const e of detailErrors) {
    let target = null;
    if (e.startsWith('Card Not Found: '))
      target = e.slice('Card Not Found: '.length).trim();
    else if (e.startsWith('Mission Not Found: '))
      target = e.slice('Mission Not Found: '.length).trim();
    else if (e.startsWith('Points Mismatch: '))
      target = e.slice('Points Mismatch: '.length).replace(/ \(expected.*/, '').trim();

    if (target !== null)
      details.forEach((d, i) => { if (d.trim() === target) errorIndices.add(i); });
    else
      aggregateError = true;
  }

  const label = document.createElement('label');
  label.className = 'field-label';
  label.textContent = 'missionDetails';
  if (aggregateError) {
    const star = document.createElement('span');
    star.className = 'error-star';
    star.textContent = '*';
    label.appendChild(star);
  }
  row.appendChild(label);

  const imgs = debugImages?.['missionDetails'] ?? [];
  const count = Math.max(details.length, 1);

  for (let i = 0; i < count; i++) {
    const entry = document.createElement('div');
    entry.className = 'detail-entry';

    const input = document.createElement('input');
    input.type = 'text';
    input.dataset.field = 'missionDetails';
    input.value = details[i] ?? '';
    entry.appendChild(input);

    if (errorIndices.has(i)) {
      const star = document.createElement('span');
      star.className = 'error-star';
      star.textContent = '*';
      entry.appendChild(star);
    }

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.className = 'btn-delete';
    removeBtn.onclick = function() { entry.remove(); };
    entry.appendChild(removeBtn);

    if (i < imgs.length) {
      const filename = imgs[i].split(/[\\/]/).pop();
      const img = document.createElement('img');
      img.src = '/debug-images/' + filename;
      img.alt = 'missionDetails debug image';
      entry.appendChild(img);
    }

    row.appendChild(entry);
  }

  return row;
}

async function saveMission(btn) {
  const det = btn.closest('details');
  const id = parseInt(det.dataset.id, 10);
  const statusEl = btn.nextElementSibling;

  const body = {};
  for (const input of det.querySelectorAll('input[data-field]:not([data-field="missionDetails"])')) {
    body[input.dataset.field] = input.value;
  }
  body.missionDetails = Array.from(det.querySelectorAll('input[data-field="missionDetails"]'))
    .map(i => i.value.trim())
    .filter(s => s.length > 0);

  const res = await fetch('/api/missions/' + id, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });

  if (res.ok) {
    const updated = await res.json();
    det.querySelector('summary').textContent = summaryText(updated);
    statusEl.className = 'save-status';
    statusEl.textContent = 'Saved.';
    setTimeout(() => { statusEl.textContent = ''; }, 2000);
  } else {
    statusEl.className = 'save-status error';
    statusEl.textContent = 'Save failed (' + res.status + ')';
  }
}

async function deleteMission(btn) {
  const det = btn.closest('details');
  const id = parseInt(det.dataset.id, 10);
  const res = await fetch('/api/missions/' + id, { method: 'DELETE' });
  if (res.ok) {
    delete fieldErrors[id];
    det.remove();
    const data = await res.json();
    updateTitle(data.missionCount);
  } else {
    btn.nextElementSibling
      ? btn.nextElementSibling.textContent = 'Delete failed'
      : btn.insertAdjacentText('afterend', ' Delete failed');
  }
}

function handlePipelineResponse(data) {
  fieldErrors = data.errors?.length > 0 ? buildErrorMap(data.errors) : {};
  let logText = data.log ?? '';
  if (data.errors && data.errors.length > 0) {
    logText += '\n\n' + data.errors.length + ' validation error(s):\n';
    for (const e of data.errors) {
      logText += '  Mission ' + e.missionId + ' (' + e.missionName + '): ' + e.errorType + '\n';
    }
  }
  setLog(logText);
  refreshMissions();
}

async function runCapture() {
  fieldErrors = {};
  setLog('Capturing...');
  const res = await fetch('/api/capture', { method: 'POST' });
  const data = await res.json();
  setLog(data.log || '');
  refreshMissions();
}

async function runCaptureDetailsBottom() {
  fieldErrors = {};
  setLog('Capturing more details...');
  const res = await fetch('/api/capture-details-bottom', { method: 'POST' });
  if (!res.ok) {
    const data = await res.json();
    setLog(data.error ?? 'Error');
    return;
  }
  const data = await res.json();
  setLog(data.log ?? '');
  refreshMissions();
}

async function runValidate() {
  setLog('Validating...');
  const res = await fetch('/api/validate', { method: 'POST' });
  if (!res.ok) {
    const data = await res.json();
    setLog(data.error ?? 'Error');
    return;
  }
  handlePipelineResponse(await res.json());
}

async function runTransform() {
  setLog('Transforming...');
  const res = await fetch('/api/transform', { method: 'POST' });
  if (!res.ok) {
    const data = await res.json();
    setLog(data.error ?? 'Error');
    return;
  }
  handlePipelineResponse(await res.json());
}

async function runSaveUnstructured() {
  setLog('Saving...');
  const res = await fetch('/api/save-unstructured', { method: 'POST' });
  if (!res.ok) {
    const data = await res.json();
    setLog(data.error ?? 'Error');
    return;
  }
  const data = await res.json();
  setLog(data.log ?? '');
}

function toggleLoadForm() {
  const form = document.getElementById('load-form');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

async function runLoadUnstructured() {
  const filePath = document.getElementById('load-path').value.trim();
  if (!filePath) {
    setLog('Please enter a file path.');
    return;
  }
  setLog('Loading...');
  const res = await fetch('/api/load-unstructured', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ filePath })
  });
  if (!res.ok) {
    const data = await res.json();
    setLog(data.error ?? 'Error');
    return;
  }
  const data = await res.json();
  setLog(data.log ?? '');
  refreshMissions();
}

async function runClearMissions() {
  fieldErrors = {};
  const res = await fetch('/api/missions', { method: 'DELETE' });
  const data = await res.json();
  setLog('Missions cleared.');
  refreshMissions();
}

async function runDeleteDebugImages() {
  const res = await fetch('/api/debug-images', { method: 'DELETE' });
  const data = await res.json();
  setLog('Deleted ' + data.deletedCount + ' debug image(s).');
  refreshMissions();
}

// Load missions on page load
refreshMissions();
</script>
</body>
</html>
